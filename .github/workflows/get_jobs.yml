# GITHUB ACTIONS WORKFLOW FOR: MyIntern-git/2026-Intern-Opportunities
# 
# INSTRUCTIONS:
# 1. Create this file at: .github/workflows/get_jobs.yml in your GitHub repository
# 2. Add the required secrets in GitHub Settings > Secrets and variables > Actions:
#    - SUPABASE_URL: Your Supabase project URL
#    - SUPABASE_SERVICE_KEY: Your Supabase service role key (not anon key)
# 3. Ensure repository has Actions enabled and proper permissions
#
# This workflow fetches internship data and updates your Supabase tables.

name: Get Jobs and Update Tables

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allows manual triggering from GitHub UI
  push:
    branches:
      - main
    paths:
      - '.github/workflows/get_jobs.yml'
      - 'scripts/**'

# Set permissions for the workflow
permissions:
  contents: write
  actions: read

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Skip installing dependencies
        run: echo "Skipping dependencies because none are required"


      - name: Fetch internship data
        id: fetch_data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "Starting internship data fetch..."
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          
          # Check if required secrets are set
          if [ -z "$SUPABASE_URL" ]; then
            echo "::error::SUPABASE_URL secret is not set"
            exit 1
          fi
          
          if [ -z "$SUPABASE_SERVICE_KEY" ]; then
            echo "::error::SUPABASE_SERVICE_KEY secret is not set"
            exit 1
          fi
          
          echo "Environment variables verified"
          
          # Run the fetch script with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
            
            if npm run fetch-jobs 2>&1; then
              echo "Fetch completed successfully"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Fetch failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "::warning::All retry attempts exhausted"
                echo "status=partial" >> $GITHUB_OUTPUT
              fi
            fi
          done
        continue-on-error: true

      - name: Update tables
        if: steps.fetch_data.outputs.status != 'failed'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "Updating database tables..."
          
          # Run update script with error handling
          if npm run update-tables 2>&1; then
            echo "Tables updated successfully"
          else
            echo "::warning::Table update encountered issues"
            # Don't fail the entire workflow for partial failures
          fi
        continue-on-error: true

      - name: Commit changes (if any)
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # Check for changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "chore: update internship data [skip ci]" || echo "Nothing to commit"
            git push || echo "::warning::Failed to push changes"
          fi

      - name: Generate summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Fetch Status**: ${{ steps.fetch_data.outputs.status || 'completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for any warnings or errors." >> $GITHUB_STEP_SUMMARY

  # Fallback job for handling rate limits
  handle-rate-limit:
    runs-on: ubuntu-latest
    needs: fetch-and-update
    if: failure()
    
    steps:
      - name: Check for rate limit
        run: |
          echo "Previous job failed. This could be due to:"
          echo "1. API rate limiting (403/429 errors)"
          echo "2. Authentication issues (401 errors)"
          echo "3. Network connectivity problems"
          echo ""
          echo "Recommended actions:"
          echo "- Check GitHub Secrets are properly configured"
          echo "- Verify Supabase project is active"
          echo "- Wait for rate limit reset if applicable"
          echo ""
          echo "::warning::Workflow will retry on next scheduled run"
